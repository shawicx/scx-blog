---
import LanguageSwitcherIcon from '@/components/SvgIcons/LanguageSwitcherIcon.astro'
import ThemeToggleIcon from '@/components/SvgIcons/ThemeToggleIcon.astro'
import themeConfig, { moreLocales } from '@/config'
import { getNextGlobalLangPath, getNextSupportedLangPath } from '@/i18n/path'
import { ui } from '@/i18n/ui'
import { getPageInfo } from '@/utils/page'

interface Props {
  supportedLangs?: string[]
}

const { supportedLangs = [] } = Astro.props
const { currentLang, getLocalizedPath, isPost, isHome, isTag, isAbout } = getPageInfo(Astro.url.pathname)
const currentUI = ui[currentLang as keyof typeof ui] ?? {}
const {
  light: { background: lightMode },
  dark: { background: darkMode },
} = themeConfig.color

// Navigation items
// 修复首页时文章菜单的激活状态问题
const isPostActive = isPost && !isHome // 只有在文章页且不是首页时才激活
const isTagActive = isTag
const isAboutActive = isAbout

function getNavItemClass(isActive: boolean) {
  return isActive
    ? 'highlight-static c-primary font-bold after:bottom-0.7em'
    : 'highlight-hover transition-[colors,font-weight] after:bottom-0.7em hover:(c-primary font-bold)'
}

const navItems = [
  {
    href: '/',
    label: '首页',
    className: getNavItemClass(isHome && !isPost),
  },
  {
    label: currentUI.posts || '文章',
    className: getNavItemClass(isPostActive),
    children: [
      {
        href: '/posts/work-docs/',
        label: '工作文档记录',
      },
      {
        href: '/posts/scattered-notes/',
        label: '零散笔记',
      },
    ],
  },
  {
    href: '/tags/',
    label: currentUI.tags,
    className: getNavItemClass(isTagActive),
  },
  {
    href: '/about/',
    label: currentUI.about,
    className: getNavItemClass(isAboutActive),
  },
]

// Language switcher
const showLanguageSwitcher = moreLocales.length > 0
const nextUrl = supportedLangs.length > 0
  ? getNextSupportedLangPath(Astro.url.pathname, supportedLangs)
  : getNextGlobalLangPath(Astro.url.pathname)
---

<!-- Top Navigation Bar -->
<div class="mb-8 w-full border-b border-gray-200 dark:border-gray-700">
  <div class="mx-auto max-w-6xl px-4 py-4">
    <div class="flex items-center justify-between">
      <!-- Navigation Menu -->
      <nav
        aria-label="Site Navigation"
        class:list={[
          'text-3.6 font-semibold leading-2.45em font-navbar',
          'lg:(text-4) cjk:tracking-0.02em',
        ]}
      >
        <ul class="flex items-center gap-6">
          {navItems.map(item => (
            <li class="group relative">
              {item.children
? (
                <div class="dropdown">
                  <span
                    class:list={[
                      item.className,
                      'flex items-center gap-1 cursor-default',
                    ]}
                    aria-expanded="false"
                    aria-haspopup="true"
                  >
                    {item.label}
                    <span class="text-xs transition-transform group-hover:rotate-180">▼</span>
                  </span>
                  <ul
                    class="invisible absolute left-0 top-full z-50 mt-2 min-w-40 border border-gray-200 rounded-lg bg-white py-2 opacity-0 shadow-lg transition-all duration-200 group-hover:visible dark:border-gray-700 dark:bg-gray-800 group-hover:opacity-100"
                    role="menu"
                    aria-label={`${item.label}子菜单`}
                  >
                    {item.children.map(child => (
                      <li role="none">
                        <a
                          href={getLocalizedPath(child.href)}
                          class="block px-4 py-2 text-sm transition-colors hover:bg-gray-100 dark:hover:bg-gray-700"
                          role="menuitem"
                        >
                          {child.label}
                        </a>
                      </li>
                    ))}
                  </ul>
                </div>
              )
: (
                <a
                  href={getLocalizedPath(item.href)}
                  class={item.className}
                >
                  {item.label}
                </a>
              )}
            </li>
          ))}
        </ul>
      </nav>

      <!-- Controls (Language Switcher + Theme Toggle) -->
      <div class="flex items-center gap-4">
        <!-- Language Switcher -->
        {showLanguageSwitcher && (
          <a
            id="language-switcher"
            href={nextUrl}
            class="aspect-square w-4 c-secondary transition-all active:scale-90 hover:c-primary"
            aria-label="Switch website language"
          >
            <LanguageSwitcherIcon
              aria-hidden="true"
              fill="currentColor"
            />
          </a>
        )}

        <!-- Theme Toggle -->
        <button
          id="theme-toggle-button"
          class="aspect-square w-4 c-secondary transition-all active:scale-90 hover:c-primary"
          aria-label="Switch light/dark theme"
        >
          <ThemeToggleIcon
            aria-hidden="true"
            fill="currentColor"
          />
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Theme Toggle Script -->
<script
  is:inline
  define:vars={{
    lightMode,
    darkMode,
 }}
>
// Apply theme changes
function applyTheme(isDark) {
  document.documentElement.classList.toggle('dark', isDark)

  // Update meta theme-color tag
  const metaThemeColor = document.head.querySelector('meta[name="theme-color"]')
  if (metaThemeColor && lightMode && darkMode) {
    metaThemeColor.setAttribute('content', isDark ? darkMode : lightMode)
  }

  localStorage.setItem('theme', isDark ? 'dark' : 'light')
  document.dispatchEvent(new Event('theme-changed'))
}

// Toggle theme mode
function toggleTheme() {
  const isDark = !document.documentElement.classList.contains('dark')
  applyTheme(isDark)
}

// Handle theme toggle click events
function handleThemeToggleClick(e) {
  const target = e.target instanceof Element ? e.target : null
  const button = target?.closest('#theme-toggle-button')

  if (!button) {
    return
  }

  // If reduceMotion is enabled, update theme directly
  if (document.documentElement.classList.contains('reduce-motion')) {
    toggleTheme()
    return
  }

  // Add temporary markers before view transition
  document.documentElement.style.setProperty('view-transition-name', 'animation-theme-toggle')
  document.documentElement.setAttribute('data-theme-changing', '')

  // Use View Transitions API for theme toggle
  const transition = document.startViewTransition(toggleTheme)

  // Remove temporary markers after view transition
  transition.finished.then(() => {
    document.documentElement.style.removeProperty('view-transition-name')
    document.documentElement.removeAttribute('data-theme-changing')
  })
}

// Bind click event to the button
document.addEventListener('click', handleThemeToggleClick, { passive: true })

// Listen to system theme changes in real time
window.matchMedia('(prefers-color-scheme: dark)')
  .addEventListener('change', (event) => {
    const isDark = event.matches
    // Apply system theme preference
    applyTheme(isDark)
  })
</script>

<style>
/* Dropdown Menu Styles */
.dropdown:hover ul {
  opacity: 1;
  visibility: visible;
}

/* Mobile Navigation */
@media (max-width: 768px) {
  nav ul {
    flex-direction: column;
    gap: 1rem;
  }

  .dropdown ul {
    position: static;
    opacity: 1;
    visibility: visible;
    box-shadow: none;
    border: none;
    background: transparent;
    padding: 0;
    margin-top: 0.5rem;
  }

  .dropdown ul li a {
    padding: 0.25rem 0;
    background: transparent;
  }
}
</style>
